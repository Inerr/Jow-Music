// TODO: Use @hammerhq/logger (hammer_modules) when cli finished
import * as pogger from "pogger";
import { AnyObject } from "@hammerhq/cli-tool/dist";
import { checkIfProjectExists, createModulesFolder } from "../../utils";
import chalk from "chalk";
import { readFileSync, writeFileSync } from "fs";
import { join } from "path";
import { parse, stringify } from "@iarna/toml";
import { createDeclarationFile } from "../../utils";

export const node = async (args: AnyObject) => {
	if (!checkIfProjectExists()) return;
	createModulesFolder();

	const { packages } = args;
	if (!packages) {
		pogger.error("Please specify a package name.");
		return;
	}

	pogger.event(
		`Adding package(s) ${chalk.yellow(
			packages.join(", "),
		)} to ${chalk.yellow("node_dependencies")}...`,
	);

	let content = readFileSync(join(process.cwd(), "hammer.toml"), "utf-8");
	const toml = parse(content);

	toml.node_dependencies = toml.node_dependencies || [];
	for (const pkg of packages) {
		if (!(toml.node_dependencies as string[]).includes(pkg))
			(toml.node_dependencies as string[]).push(pkg);
	}

	content = stringify(toml);
	writeFileSync(join(process.cwd(), "hammer.toml"), content);

	createDeclarationFile();

	pogger.success("Package(s) added successfully!");
};
